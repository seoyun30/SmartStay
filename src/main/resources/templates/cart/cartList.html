<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/userlayout}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link th:href="@{/css/stikysidebar.css}" rel="stylesheet">
    <style layout:fragment="css">
        #contain {
            position: relative;
            width: 75%;
            margin: 0 auto;
        }

        #aside {
            position: sticky;
            border: 1px solid #a2aec7;
            background-color: white;
            left: 0;
            right: 0;
            bottom: 0;
            width: 75%;
            height: 100%;
        }

        .square-image {
            position: relative;
            width: 100%;
            padding-top: 100%; /* 가로 세로 비율 1:1 유지 */
            overflow: hidden;
        }

        .square-image img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>

<th:block layout:fragment="content">

    <div id="contain" class="card w-75 mt-5 mx-auto">

        <div class="card-title">
            <h2 class="mt-3 text-center fw-bold">장바구니</h2>
            <hr>
        </div>

        <span class="h4 ms-3 fw-bold">룸 예약</span>

        <div class="card-body">

            <th:block th:if="${roomItemDTOList.isEmpty()}">
                <div class="mt-3">
                    <span class="h5 fw-bold">장바구니가 비어있습니다.</span>
                </div>
            </th:block>

            <th:block th:unless="${roomItemDTOList.isEmpty()}" th:each="roomItem, iterStat : ${roomItemDTOList}">

                <th:block th:if="${iterStat.index == 0 or roomItem.roomDTO.hotelDTO.hotel_name != roomItemDTOList[iterStat.index - 1].roomDTO.hotelDTO.hotel_name or roomItem.roomDTO.hotelDTO.address != roomItemDTOList[iterStat.index - 1].roomDTO.hotelDTO.address}">
                    <div class="p-3">
                        <span class="h4 fw-bold" th:text="${roomItem.roomDTO.hotelDTO.hotel_name}">호텔 매장 이름</span> <br>
                        <small class="text-body-secondary" th:text="${roomItem.roomDTO.hotelDTO.address}">매장 주소</small>
                        <hr>
                    </div>
                </th:block>

                <div class="p-3">
                    <div class="row mb-2">
                        <div class="col-md-8">
                            <input type="hidden" class="hotelName" name="hotelName" th:value="${roomItem.roomDTO.hotelDTO.hotel_name}">
                            <p class="card-text fs-5 fw-bold roomName"> [[${roomItem.roomDTO.room_name}]] / [[${roomItem.roomDTO.room_type}]] </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button th:value="${roomItem.roomitem_num}" class="btn btn-outline-dark btn-sm roomRemoveBtn" aria-label="Close"><i class="bi bi-x-lg"></i></button>
                        </div>
                    </div>

                    <div class="row g-0">
                        <div class="col-md-2 align-self-center">
                            <input type="checkbox" class="btn-check" name="roomChkBox" th:value="${roomItem.roomitem_num}" th:id="'roomCheck-' + ${iterStat.index}" autocomplete="off">
                            <label class="btn btn-outline-danger" th:for="'roomCheck-' + ${iterStat.index}"><i class="bi bi-check-lg"></i></label><br>
                        </div>

                        <div class="col-md-3 align-self-center">
                            <th:block th:each="img: ${roomItem.imageDTOList}">
                                <th:block th:if="${img.repimg_yn == 'Y'}">
                                    <div class="col-12 square-image">
                                        <img class="img-fluid" th:src="${img.thumbnail_url}" alt="대표 이미지">
                                    </div>
                                </th:block>
                            </th:block>
                        </div>

                        <div class="col-md-7 align-self-center">
                            <div class="card-body reserveinfo" >
                                <input type="hidden" class="roomItemNumber" name="roomItem_num" th:value="${roomItem.roomitem_num}">
                                <input type="hidden" class="roomNumber" name="room_num" th:value="${roomItem.roomDTO.room_num}">
                                <span class="reserveDate">[[${#temporals.format(roomItem.in_date, 'yyyy-MM-dd HH:mm')}]]~[[${#temporals.format(roomItem.out_date,'yyyy-MM-dd HH:mm')}]] | [[${roomItem.day}]]박</span> <br>
                                <span class="fs-6 reserveCount">최대 [[${roomItem.roomDTO.room_bed}]]명 / 예약인원 [[${roomItem.count}]]명</span> <br>
                                <span>룸서비스 신청</span> <br>
                                <span class="reserveRequest">요청사항 : [[${roomItem.reserve_request}]]</span>
                                <input type="hidden" class="roomPrice" th:value="${roomItem.roomDTO.room_price}">
                                <input type="hidden" class="reserveDay" th:value="${roomItem.day}">
                                <h5 class="text-end fw-bold roomreservePrice"></h5>
                            </div>
                        </div>

                        <th:block th:if="${iterStat.index == 0
                        or roomItem.roomDTO.room_name != roomItemDTOList[iterStat.index - 1].roomDTO.room_name
                        or roomItem.in_date != roomItemDTOList[iterStat.index - 1].in_date
                        or roomItem.out_date != roomItemDTOList[iterStat.index - 1].out_date
                        or roomItem.reserve_request != roomItemDTOList[iterStat.index - 1].reserve_request}">
                            <div>
                                <hr>
                            </div>
                        </th:block>
                    </div>

                </div>

            </th:block>

        </div>

        <hr>

        <span class="h4 ms-3 fw-bold">룸서비스 주문</span>

        <div class="card-body">
            <th:block th:if="${orderItemDTOList.isEmpty()}">
                <div class="mt-3">
                    <span class="h5 fw-bold">장바구니가 비어있습니다.</span>
                </div>
            </th:block>

            <th:block th:unless="${orderItemDTOList.isEmpty()}" th:each="orderItem, iterStat : ${orderItemDTOList}">

                <th:block th:if="${iterStat.index == 0
                or orderItem.roomReserveItemDTO.roomDTO.hotelDTO.hotel_name != orderItemDTOList[iterStat.index - 1].roomReserveItemDTO.roomDTO.hotelDTO.hotel_name}">
                    <div class="p-3">
                    <span class="h4 fw-bold"
                          th:text="${orderItem.roomReserveItemDTO.roomDTO.hotelDTO.hotel_name}">
                        호텔 매장 이름
                    </span>
                        <br>
                        <small class="text-body-secondary"
                               th:text="${orderItem.roomReserveItemDTO.roomDTO.hotelDTO.address}">
                            매장 주소
                        </small>
                        <hr>
                    </div>
                </th:block>

                <div class="p-3">
                    <div class="row mb-2">
                        <div class="col-md-8">
                            <p class="card-text fs-5 fw-bold roomName"> [[${orderItem.roomReserveItemDTO.roomDTO.room_name}]] / [[${orderItem.roomReserveItemDTO.roomDTO.room_type}]] </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button th:value="${orderItem.service_num}" class="btn btn-outline-dark btn-sm serviceRemoveBtn" aria-label="Close">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>

                    <div class="row g-0">
                        <div class="col-md-1 align-self-center">
                            <input type="checkbox" class="btn-check" name="serviceChkBox" th:value="${orderItem.service_num}" th:id="'serviceCheck-' + ${iterStat.index}" autocomplete="off">
                            <label class="btn btn-outline-danger" th:for="'serviceCheck-' + ${iterStat.index}"><i class="bi bi-check-lg"></i></label><br>
                        </div>

                        <div class="col-md-11 align-self-center">
                            <div class="card-body roomServiceInfo">

                                <h4 class="mb-3 fw-bold">룸케어 서비스</h4>
                                <th:block th:each="careItem : ${orderItem.careItemDTOList}">
                                    <div class="row mb-3">
                                        <div class="col-md-2 align-self-center">
                                            <th:block th:each="img: ${careItem.imageDTOList}">
                                                <th:block th:if="${img.repimg_yn == 'Y'}">
                                                    <div class="square-image">
                                                        <img class="img-fluid" th:src="${img.image_url}" alt="대표 이미지">
                                                    </div>
                                                </th:block>
                                            </th:block>
                                        </div>
                                        <div class="col-md-10 align-self-center">
                                            <input type="hidden" class="careitem_num" th:value="${careItem.careitem_num}">
                                            <p class="h5" th:text="${careItem.careDTO.care_name}"></p>
                                            <p class="h5 care_count" th:text="${careItem.care_count + '개'}"></p>
                                            <p class="h5 care_price" th:text="${careItem.careDTO.care_price + '원'}"></p>
                                        </div>
                                    </div>
                                </th:block>

                                <h4 class="mb-3 fw-bold">주문 메뉴</h4>
                                <th:block th:each="menuItem : ${orderItem.menuItemDTOList}">
                                    <div class="row">
                                        <div class="col-md-2 align-self-center">
                                            <th:block th:each="img: ${menuItem.imageDTOList}">
                                                <th:block th:if="${img.repimg_yn == 'Y'}">
                                                    <div class="square-image">
                                                        <img class="img-fluid" th:src="${img.image_url}" alt="대표 이미지">
                                                    </div>
                                                </th:block>
                                            </th:block>
                                        </div>

                                        <div class="col-md-10 align-self-center">
                                            <input type="hidden" class="menuitem_num" th:value="${menuItem.menuitem_num}">
                                            <p class="h5" th:text="${menuItem.menuDTO.menu_name}"></p>
                                            <p class="h5 menu_count" th:text="${menuItem.menu_count + '개'}"></p>
                                            <p class="h5 menu_price" th:text="${menuItem.menuDTO.menu_price + '원'}"></p>
                                        </div>

                                    </div>
                                </th:block>
                                <h5 class="mt-3 fw-bold menu_request">요청사항 : [[${orderItem.menu_request}]]</h5>

                                <h5 class="mt-3 text-end fw-bold">총 가격 <span class="text-danger" th:id="'servicePrice-' + ${orderItem.service_num}">0</span>원</h5>

                            </div>
                        </div>

                        <th:block th:if="${iterStat.index == 0
                or orderItem.roomReserveItemDTO.roomDTO.hotelDTO.hotel_name != orderItemDTOList[iterStat.index - 1].roomReserveItemDTO.roomDTO.hotelDTO.hotel_name}">
                            <div>
                                <hr>
                            </div>
                        </th:block>
                    </div>
                </div>

            </th:block>

        </div>

    </div>

    <aside class="border-top" id="aside">

        <div class="p-3 mb-3">
            <div class="row">
                <div class="col-md-6 align-self-center">
                    <span class="card-text fs-5 fw-bold checkedCount">총 0건</span>
                </div>
                <div class="col-md-6 align-self-center text-end">
                    <span class="card-text fs-5 fw-bold">총 결제 예정 금액</span>
                    <h3 class="fw-bold"><span class="text-danger" id="orderTotalPrice">0</span>원</h3>
                </div>
            </div>

            <div class="d-grid gap-2 col-6 mx-auto text-center mt-2">
                <button class="btn btn-primary btn-lg buybtn" type="submit">결제하기</button>
            </div>
        </div>

    </aside>

    <!-- 룸예약 수정 모달 -->
    <div class="modal fade" id="roomModal" tabindex="-1" aria-labelledby="roomModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title roomHotel fw-bold">호텔 매장 이름 <span class="fs-4 roomModalRoom fw-bold"> 룸 이름 / 룸 타입</span></h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <input type="hidden" class="modalRoomItem_num" name="roomItem_num">
                        <input type="hidden" class="modalRoom_num" name="room_num">
                        <div class="col">
                            <span class="fs-6 text-secondary">체크인</span> <br>
                            <input class="modalIn_date" type="datetime-local" name="in_date">
                        </div>
                        <div class="col">
                            <span class="fs-6 text-secondary">체크아웃</span> <br>
                            <input class="modalOut_date" type="datetime-local" name="out_date">
                        </div>
                    </div>

                    <span class="fs-6 maxCount">최대 1명 예약 가능</span>
                    <div class="input-group mb-3">
                        <span class="input-group-text" id="basic-addon1">예약 인원</span>
                        <input type="number" class="form-control modalCount" name="count" min="1"
                               placeholder="예약 인원 수를 입력하세요.">
                    </div>

                    <div class="mb-3">
                        <label for="exampleFormControlTextarea1" class="form-label">요청사항</label>
                        <textarea class="form-control modalReserve_request" name="reserve_request" id="exampleFormControlTextarea1" rows="3"></textarea>
                    </div>

                    <div class="text-end mb-3">
                        <span>숙박/1박당 </span> <input type="hidden" class="modalDay" name="day">
                        <span class="fs-5 fw-bold modalPrice">10000</span>
                        <span>원</span>
                        <h3 class="fw-bold">총 금액 <span class="text-danger roomTotalPrice">10000</span>원</h3>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary roomReserveModifyBtn">수정</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 룸서비스 수정 모달 -->
    <div class="modal fade" id="serviceModal" tabindex="-1" aria-labelledby="serviceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title serviceHotel fw-bold">호텔 매장 이름 <span class="fs-4 serviceRoom fw-bold"> 룸 이름 / 룸 타입</span></h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4 class="mb-3 fw-bold">룸케어 서비스</h4>
                    <div class="mb-3 careService"></div>

                    <h4 class="mb-3 fw-bold">주문 메뉴</h4>
                    <div class="mb-3 menuService"></div>

                    <div class="mb-3">
                        <label for="exampleFormControlTextarea2" class="form-label">요청사항</label>
                        <textarea class="form-control modalMenu_request" name="reserve_request" id="exampleFormControlTextarea2" rows="3"></textarea>
                    </div>

                    <div class="text-end mb-3">
                        <h3 class="fw-bold">총 금액 <span class="text-danger serviceTotalPrice">0</span>원</h3>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary roomServiceModifyBtn">수정</button>
                </div>
            </div>
        </div>
    </div>

</th:block>

<script th:inline="javascript" layout:fragment="script">

    $(document).ready(function () {

        $('.reserveinfo').each(function() {
            let roomPrice = parseFloat($(this).find('.roomPrice').val());  // 방 가격
            let reserveDay = parseInt($(this).find('.reserveDay').val());  // 예약 일수
            let roomItemNum = $(this).find('.roomItemNumber').val();  // roomitem_num 값 가져오기
            let roomreservePrice = $(this).find('.roomreservePrice');  // 가격을 삽입할 요소

            // 1박과 연박 구분하여 가격 계산
            let price = roomPrice * reserveDay;
            let priceText = '';

            if (reserveDay === 1) {
                priceText = `1박 <span class="text-danger" id="roomPrice-${roomItemNum}">${price.toLocaleString()}</span>원`;
            } else {
                priceText = `연박 <span class="text-danger" id="roomPrice-${roomItemNum}">${price.toLocaleString()}</span>원`;
            }

            roomreservePrice.html(priceText);
        });

        calculateServiceTotalPrice();

        function calculateServiceTotalPrice() {
            //케어+메뉴 총 가격 계산
            $(".roomServiceInfo").each(function () {
                let serviceTotalPrice = 0;
                let serviceNum = $(this).find("span[id^='servicePrice-']").attr("id").split('-')[1];

                // 룸케어 서비스 가격 합산
                $(this).find(".care_price").each(function () {
                    let price = parseInt($(this).text().replace(/[^0-9]/g, '')) || 0;
                    let count = parseInt($(this).siblings(".care_count").text().replace(/[^0-9]/g, '')) || 1;
                    serviceTotalPrice += price * count;
                });

                // 주문 메뉴 가격 합산
                $(this).find(".menu_price").each(function () {
                    let price = parseInt($(this).text().replace(/[^0-9]/g, '')) || 0;
                    let count = parseInt($(this).siblings(".menu_count").text().replace(/[^0-9]/g, '')) || 1;
                    serviceTotalPrice += price * count;
                });

                // 총 가격 반영
                $("#servicePrice-" + serviceNum).text(serviceTotalPrice);
            })
        }

        //체크시 가격 반영
        $("input[name=roomChkBox], input[name=serviceChkBox]").change(function () {
            getOrderTotalPrice()
        })

        //체크시 가격 반영 메소드
        function getOrderTotalPrice() {
            let orderTotalPrice  = 0;
            let checkedCount = 0;

            // 룸예약 항목 가격 계산
            $("input[name=roomChkBox]:checked").each(function () {
                    let roomitem_num = $(this).val()
                    let price = $("#roomPrice-" + roomitem_num).text()
                    price = parseInt(price.replace(/[^0-9]/g, ''));
                    orderTotalPrice += price;
                    checkedCount++;
                }
            );

            // 룸서비스 (케어, 메뉴) 항목 가격 계산
            $("input[name=serviceChkBox]:checked").each(function () {
                let service_num = $(this).val();
                let price = $("#servicePrice-" + service_num).text();
                price = parseInt(price.replace(/[^0-9]/g, ''));
                orderTotalPrice += price;
                checkedCount++;
            });

            $("#orderTotalPrice").text(orderTotalPrice)
            $(".checkedCount").text("총 " + checkedCount + "건");

        }

        //룸예약 장바구니 삭제
        $(".roomRemoveBtn").on("click", function () {
            let roomitem_num = $(this).val()

            let url = "/cart/cartRoomReserveDelete/" + roomitem_num

            $.ajax({
                url : url ,
                type: "delete",
                dataType : "json",
                success : function (result) {
                    location.href = "/cart/cartList"
                },
                error : function (result, status, error) {

                    if(result.status == '401'){
                        alert("로그인 후 이용해주세요")
                        location.href = "/member/login"
                    }else {
                        alert(result.responseText)
                    }

                }

            })

        })
        
        //룸서비스 장바구니 삭제
        $(".serviceRemoveBtn").on("click", function () {
            let service_num = $(this).val();

            let url = "/cart/cartOrderReserveDelete/" + service_num

            $.ajax({
                url : url ,
                type: "delete",
                dataType : "json",
                success : function (result) {
                    location.href = "/cart/cartList"
                },
                error : function (result, status, error) {

                    if(result.status == '401'){
                        alert("로그인 후 이용해주세요")
                        location.href = "/member/login"
                    }else {
                        alert(result.responseText)
                    }

                }

            })
        })

        //룸예약 모달창 표시
        $(".reserveinfo").on("click", function () {
            // 현재 클릭된 요소에서 필요한 데이터 가져오기
            let roomItemNumber = $(this).find(".roomItemNumber").val();
            let roomNumber = $(this).find(".roomNumber").val();
            let checkInOutText = $(this).find(".reserveDate").text().trim();
            let maxPeopleText = $(this).find(".reserveCount").text().trim();
            let requestText = $(this).find(".reserveRequest").text().trim();
            let roomPrice = $(this).find(".roomPrice").val();  // 가격
            let reserveDay = $(this).find(".reserveDay").val(); // 숙박일
            let hotelName = $(this).closest(".p-3").find(".hotelName").val(); // 호텔 매장 이름
            let roomInfoText = $(this).closest(".p-3").find(".fs-5.fw-bold").text().trim(); // 룸 이름 / 룸 타입

            // 체크인, 체크아웃 날짜 파싱
            let checkInDate = checkInOutText.split("~")[0].trim();
            let checkOutDate = checkInOutText.split("~")[1].split("|")[0].trim();

            // 최대 예약 가능 인원 및 현재 예약 인원 수 파싱
            let maxPeople = parseInt(maxPeopleText.split("최대 ")[1].split("명")[0].trim()); // 최대 예약 가능 인원
            let reservedPeople = parseInt(maxPeopleText.split("예약인원 ")[1].split("명")[0].trim()); // 현재 예약 인원

            // 요청 사항 파싱
            let requestContent = requestText.replace("요청사항 :", "").trim();

            // 요청 사항이 비어 있을 경우 기본값 설정
            if (requestContent === "") {
                requestContent = "요청 사항 없음";
            }

            // 총 가격 계산
            let totalPrice = roomPrice * reserveDay;

            // 모달 창에 데이터 삽입
            $("#roomModal input.modalRoomItem_num").val(roomItemNumber);
            $("#roomModal input.modalRoom_num").val(roomNumber);
            $("#roomModal .roomHotel").html(hotelName + ' <span class="fs-4 fw-bold">' + roomInfoText + '</span>');
            $("#roomModal input.modalIn_date").val(checkInDate);
            $("#roomModal input.modalOut_date").val(checkOutDate);
            $("#roomModal textarea.modalReserve_request").val(requestContent);
            $("#roomModal input.modalDay").val(reserveDay);
            $("#roomModal .modalPrice").text(roomPrice);
            $("#roomModal .roomTotalPrice").text(totalPrice);
            $("#roomModal .maxCount").text("최대 " + maxPeople + "명 예약 가능");
            $("#roomModal input.modalCount").attr("max", maxPeople).val(reservedPeople);

            // 모달 창 띄우기
            $("#roomModal").modal("show");

            // 모달이 열린 후 setMinDateTime 실행
            setMinDateTime()
        });

        //룸서비스 모달창 표시
        $(".roomServiceInfo").on("click", function () {
            // 해당 `.roomServiceInfo` 요소에서 필요한 데이터 가져오기
            let hotelName = $(this).closest(".p-3").prev(".p-3").find(".h4.fw-bold").text().trim();
            let roomName = $(this).closest(".p-3").find(".roomName").text().trim();
            let serviceNum = $(this).closest(".p-3").find(".serviceRemoveBtn").val();
            $("#serviceModal .roomServiceModifyBtn").val(serviceNum);

            // 룸 정보 설정
            $("#serviceModal .serviceHotel").text(hotelName);
            $("#serviceModal .serviceRoom").text(roomName);

            // 기존 모달 데이터 초기화
            $("#serviceModal .careService").empty();
            $("#serviceModal .menuService").empty();
            $("#serviceModal .modalMenu_request").val("").closest(".mb-3").show();
            $("#serviceModal h4:contains('룸케어 서비스')").show();
            $("#serviceModal h4:contains('주문 메뉴')").show();

            // 총 가격 초기화
            let totalPrice = 0;

            //룸케어 서비스 추가
            let careItems = $(this).find(".careitem_num");
            if (careItems.length > 0) {
                careItems.each(function () {
                    let careName = $(this).siblings("p:first").text();
                    let careNum = $(this).val();
                    let careCount = parseInt($(this).siblings(".care_count").text().replace("개", "").trim());
                    let carePrice = $(this).siblings(".care_price").text().trim();
                    let careImage =  $(this).closest(".col-md-10").prev(".col-md-2").find("img").attr("src"); // 대표 이미지 가져오기

                    let careHtml = `
                    <div class="row mb-3">
                        <div class="col-md-2 align-self-center">
                         <button value="${careNum}" class="btn btn-outline-dark btn-sm careRemoveBtn" aria-label="Close">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div class="col-md-3 align-self-center">
                            ${careImage ? `<img src="${careImage}" class="img-fluid rounded" alt="룸케어 이미지">` : ""}
                        </div>
                        <div class="col-md-7 align-self-center">
                            <p class="h5 mb-1">${careName} | ${carePrice}</p>
                            <div class="input-group mb-3">
                                <span class="input-group-text">수량</span>
                                <input type="number" class="form-control modalCare_count" value="${parseInt(careCount)}" min="1" max="100">
                            </div>
                        </div>
                    </div>
                `;
                    $("#serviceModal .careService").append(careHtml);

                    totalPrice += parseInt(carePrice.replace(/[^0-9]/g, "")) * careCount;

                });
            } else {
                $("#serviceModal h4:contains('룸케어 서비스')").hide();
            }

            //주문 메뉴 추가
            let menuItems = $(this).find(".menuitem_num");
            if (menuItems.length > 0) {
                menuItems.each(function () {
                    let menuName = $(this).siblings("p:first").text();
                    let menuNum = $(this).val();
                    let menuCount = parseInt($(this).siblings(".menu_count").text().replace("개", "").trim());
                    let menuPrice = $(this).siblings(".menu_price").text().trim();

                    let menuImage =  $(this).closest(".col-md-10").prev(".col-md-2").find("img").attr("src"); // 대표 이미지 가져오기

                    let menuHtml = `
                    <div class="row">
                        <div class="col-md-2 align-self-center">
                            <button value="${menuNum}" class="btn btn-outline-dark btn-sm menuRemoveBtn" aria-label="Close">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div class="col-md-3 align-self-center">
                            ${menuImage ? `<img src="${menuImage}" class="img-fluid rounded" alt="메뉴 이미지">` : ""}
                        </div>
                        <div class="col-md-7 align-self-center">
                            <p class="h5 mb-1">${menuName} | ${menuPrice}</p>
                            <div class="input-group mb-3">
                                <span class="input-group-text">수량</span>
                                <input type="number" class="form-control modalMenu_count" value="${parseInt(menuCount)}" min="1" max="100">
                            </div>
                        </div>
                    </div>
                `;
                    $("#serviceModal .menuService").append(menuHtml);

                    totalPrice += parseInt(menuPrice.replace(/[^0-9]/g, "")) * menuCount;

                });
            } else {
                $("#serviceModal h4:contains('주문 메뉴')").hide();
            }

            //요청사항 설정
            let menuRequest = $(this).closest(".p-3").find(".menu_request").text().trim();
            if (menuRequest !== "요청사항 : ") {
                $("#serviceModal .modalMenu_request").val(menuRequest.replace("요청사항 : ", ""));
            } else {
                $("#serviceModal .modalMenu_request").closest(".mb-3").hide();
            }

            $(".serviceTotalPrice").text(totalPrice.toLocaleString());

            //모달 창 띄우기
            $("#serviceModal").modal("show");
        });

        function setMinDateTime() {
            let today = new Date();
            let year = today.getFullYear();
            let month = String(today.getMonth() + 1).padStart(2, '0'); // 월 (0부터 시작하므로 +1 필요)
            let day = String(today.getDate()).padStart(2, '0'); // 일
            let hours = String(today.getHours()).padStart(2, '0'); // 현재 시간
            let minutes = String(today.getMinutes()).padStart(2, '0'); // 현재 분

            let minDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
            $(".modal .in_date").attr("min", minDateTime);
            $(".modal .out_date").attr("min", minDateTime);
        }

        $(".in_date").on("change", function () {
            let selectedDate = new Date($(this).val());
            let today = new Date();

            // 사용자가 오늘 날짜를 선택한 경우, 현재 시간 이전을 선택 못 하게 변경
            if (selectedDate.toDateString() === today.toDateString()) {
                let minTime = today.getHours().toString().padStart(2, '0') + ":" + today.getMinutes().toString().padStart(2, '0');
                let selectedTime = selectedDate.getHours().toString().padStart(2, '0') + ":" + selectedDate.getMinutes().toString().padStart(2, '0');

                if (selectedTime < minTime) {
                    alert("현재 시간 이전은 선택할 수 없습니다.");
                    $(this).val(""); // 잘못된 값 초기화
                }
            }
        });

        // 날짜 변경 시 총 가격 업데이트
        $(".in_date, .out_date").on("change", function () {
            totalpriceChange();
        });

        //룸예약 총 가격 계산 함수
        function totalpriceChange(){

            let in_date = $(".modal .in_date").val();
            let out_date = $(".modal .out_date").val();

            // 날짜가 모두 입력되지 않으면 계산하지 않음
            if (!in_date || !out_date) {
                $(".totalPrice").text($(".modal .price").text()); // 기본 1박 요금 표시
                return;
            }

            // 날짜 차이 계산
            let checkInDate = new Date(in_date);
            let checkOutDate = new Date(out_date);
            let dayDifference = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));

            // 체크아웃 날짜가 체크인 날짜보다 같거나 이전이면 계산하지 않음
            if (dayDifference <= 0) {
                alert("체크아웃 날짜는 체크인 날짜보다 이후여야 합니다.");
                $(".modal .out_date").val(""); // 잘못된 체크아웃 날짜 초기화
                $(".totalPrice").text($(".modal .price").text()); // 기본 가격으로 되돌리기
                return;
            }

            // 총 가격 계산
            let price = parseInt($(".modal .price").text().replace(/[^0-9]/g, ''));
            let totalPrice = price * dayDifference; // 소수점 올림

            $(".modal .day").val(dayDifference);
            $(".modal .totalPrice").text(totalPrice);
        }

        let deletedCareItems = []; // 삭제할 룸케어 아이템 리스트
        let deletedMenuItems = []; // 삭제할 메뉴 아이템 리스트

        //룸케어 아이템 삭제 (UI에서만 숨김)
        $("#serviceModal").on("click", ".careRemoveBtn", function () {
            let careItemId = $(this).val();
            deletedCareItems.push(careItemId); // 삭제 목록에 추가
            $(this).closest(".row").hide(); // UI에서 숨김 처리
            updateTotalPrice();
        });

        //메뉴 아이템 삭제 (UI에서만 숨김)
        $("#serviceModal").on("click", ".menuRemoveBtn", function () {
            let menuItemId = $(this).val();
            deletedMenuItems.push(menuItemId); // 삭제 목록에 추가
            $(this).closest(".row").hide(); // UI에서 숨김 처리
            updateTotalPrice();
        });

        //룸서비스 수량 변경 감지
        $("#serviceModal").on("input", ".modalCare_count, .modalMenu_count", function () {
            let quantity = parseInt($(this).val(), 10);
            if (quantity < 1 || quantity > 100) {
                alert("주문 수량은 1 이상, 100 이하로 입력해야 합니다.");
                $(this).val(quantity < 1 ? 1 : 100);
            }

            updateTotalPrice();
        });

        //룸서비스 총 가격 계산 함수
        function updateTotalPrice() {
            let totalPrice = 0;

            $("#serviceModal .careService .row:visible").each(function () {
                let carePrice = parseInt($(this).find("p.h5").text().split("|")[1].trim().replace(/[^0-9]/g, ""), 10);
                let careCount = parseInt($(this).find(".modalCare_count").val(), 10);
                totalPrice += carePrice * careCount;
            });

            $("#serviceModal .menuService .row:visible").each(function () {
                let menuPrice = parseInt($(this).find("p.h5").text().split("|")[1].trim().replace(/[^0-9]/g, ""), 10);
                let menuCount = parseInt($(this).find(".modalMenu_count").val(), 10);
                totalPrice += menuPrice * menuCount;
            });

            $(".serviceTotalPrice").text(totalPrice.toLocaleString());

            if ($("#serviceModal .careService .row").length > 0) {
                $("#serviceModal h4:contains('룸케어 서비스')").show();
            } else {
                $("#serviceModal h4:contains('룸케어 서비스')").hide();
            }

            if ($("#serviceModal .menuService .row").length > 0) {
                $("#serviceModal h4:contains('주문 메뉴')").show();
            } else {
                $("#serviceModal h4:contains('주문 메뉴')").hide();
            }
        }

        //룸예약 수정
        $(".roomReserveModifyBtn").on("click", function () {
            let today = new Date();
            today.setHours(0, 0, 0, 0); // 현재 날짜 (시간 00:00:00으로 설정)

            let roomitem_num = $("#roomModal .modalRoomItem_num").val();
            let room_num = $("#roomModal .modalRoom_num").val();
            let in_date = new Date($("#roomModal .modalIn_date").val());
            let out_date = new Date($("#roomModal .modalOut_date").val());
            let day = $("#roomModal .modalDay").val();
            let reserve_request = $("#roomModal .modalReserve_request").val();
            let maxPeople = parseInt($("#roomModal .maxCount").text().replace("최대 ", "").replace("명 예약 가능", "").trim());
            let count = parseInt($("#roomModal .modalCount").val());

            //유효성 검사
            if (!room_num) {
                alert("잘못된 방 정보입니다.");
                return;
            }
            if (!in_date || isNaN(in_date.getTime())) {
                alert("체크인 날짜를 선택해주세요.");
                return;
            } else if (in_date < today) {
                alert("이미 지난 날짜는 선택할 수 없습니다.");
                $("#roomModal .modalIn_date").val(""); // 입력값 초기화
                return;
            }

            if (!out_date || isNaN(out_date.getTime())) {
                alert("체크아웃 날짜를 선택해주세요.");
                return;
            }   else if (out_date < today) {
                alert("이미 지난 날짜로 선택할 수 없습니다.");
                $(".modal .out_date").val(""); // 입력값 초기화
                return;
            }
            if (out_date <= in_date) {
                alert("체크아웃 날짜는 체크인 날짜보다 이후여야 합니다.");
                $("#roomModal .modalOut_date").val(""); // 입력값 초기화
                return;
            }

            if (!count || count < 1) {
                alert("예약 인원 수를 입력해주세요.");
                return;
            } else if (count > maxPeople) {
                alert("최대 예약 가능 인원을 초과할 수 없습니다. (최대 예약 가능 인원: " + maxPeople + "명)");
                $("#roomModal .modalCount").val(maxPeople); // 최대 인원으로 값 변경
                return; // 수정 요청 중단
            }

            // 요청 사항이 비어 있을 경우 기본값 설정
            if (reserve_request === "") {
                reserve_request = "요청 사항 없음";
            }

            //날짜를 "YYYY-MM-DDTHH:MM" 형식으로 변환
            let formatDate = (date) => {
                return date.toISOString().slice(0, 16);
            };

            let roomItemDTO = {
                roomitem_num : roomitem_num,
                room_num : room_num,
                in_date: formatDate(in_date),
                out_date: formatDate(out_date),
                day : day,
                count : count,
                reserve_request : reserve_request
            }

            console.log(roomItemDTO)

            $.ajax({
                url : "/cart/cartRoomReserveModify",
                type : "post",
                data: roomItemDTO,
                success : function (result) {
                    $("#roomModal").modal("hide");
                    location.reload(); // 페이지 새로 고침
                },
                error : function (xhr) {
                    console.error("에러 발생:", xhr.responseText);
                    alert("예약 수정에 실패했습니다. 고객센터에 문의해주세요.");
                }
            })
        })

        //룸서비스 삭제 및 수정
        $(".roomServiceModifyBtn").on("click", function () {
            let serviceNum = $("#serviceModal .roomServiceModifyBtn").val(); // 서비스 번호
            let menuRequest = $("#serviceModal .modalMenu_request").val().trim(); // 요청 사항

            let careItemDTOList = [];
            $("#serviceModal .careService .row:visible").each(function () {
                let careItemNum = $(this).find(".careRemoveBtn").val();
                let careCount = parseInt($(this).find(".modalCare_count").val());

                if (careItemNum && careCount >= 0) {
                    careItemDTOList.push({
                        careitem_num: careItemNum,
                        care_count: careCount
                    });
                }
            });

            let menuItemDTOList = [];
            $("#serviceModal .menuService .row:visible").each(function () {
                let menuItemNum = $(this).find(".menuRemoveBtn").val();
                let menuCount = parseInt($(this).find(".modalMenu_count").val());

                if (menuItemNum && menuCount >= 0) {
                    menuItemDTOList.push({
                        menuitem_num: menuItemNum,
                        menu_count: menuCount
                    });
                }
            });

            //요청 사항이 비어 있으면 기본값 설정
            if (!menuRequest) {
                menuRequest = "요청 사항 없음";
            }

            //전송할 데이터 구성
            let orderItemDTO = {
                service_num: serviceNum,
                menu_request: menuRequest,
                careItemDTOList: careItemDTOList,
                menuItemDTOList: menuItemDTOList
            };

            console.log("삭제된 케어 아이템:", deletedCareItems);
            console.log("삭제된 메뉴 아이템:", deletedMenuItems);
            console.log("최종 전송 데이터:", orderItemDTO);

            let deleteRequests = [];

            deletedCareItems.forEach(careItemId => {
                deleteRequests.push(
                    $.ajax({
                        url: `/cart/careItemDelete/${careItemId}`,
                        type: "DELETE",
                    })
                );
            });

            deletedMenuItems.forEach(menuItemId => {
                deleteRequests.push(
                    $.ajax({
                        url: `/cart/menuItemDelete/${menuItemId}`,
                        type: "DELETE",
                    })
                );
            });

            $.when.apply($, deleteRequests).done(function () {
                let hasCareItems = $("#serviceModal .careService .row:visible").length > 0;
                let hasMenuItems = $("#serviceModal .menuService .row:visible").length > 0;

                // **(3) 모든 아이템이 삭제되었다면 orderItem도 삭제**
                if (!hasCareItems && !hasMenuItems) {
                    $.ajax({
                        url: `/cart/cartOrderReserveDelete/${serviceNum}`,
                        type: "DELETE",
                        success: function () {
                            alert("주문이 삭제되었습니다.");
                            $("#serviceModal").modal("hide");
                            location.reload();
                        },
                        error: function (xhr) {
                            console.error("주문 삭제 오류:", xhr.responseText);
                            alert("주문을 삭제하는 중 오류가 발생했습니다.");
                        }
                    });

                } else {

                    $.ajax({
                        url: "/cart/cartOrderReserveModify",
                        type: "POST",
                        contentType: 'application/json; charset=utf-8',
                        data: JSON.stringify(orderItemDTO),
                        success: function () {
                            alert("주문 정보가 수정되었습니다.");
                            $("#serviceModal").modal("hide");
                            location.reload();
                        },
                        error: function (xhr) {
                            console.error("에러 발생:", xhr.responseText);
                            alert("주문 수정에 실패했습니다. 고객센터에 문의해주세요.");
                        }
                    });
                }
            });
        });

        $(".buybtn").on("click", function (e) {
            e.preventDefault(); // 기본 제출 이벤트 방지

            let roomitem_nums = [];
            let service_nums = [];

            $("input[name=roomChkBox]:checked").each(function () {
                roomitem_nums.push($(this).val());
            });

            $("input[name=serviceChkBox]:checked").each(function () {
                service_nums.push($(this).val());
            });

            if (roomitem_nums.length === 0 && service_nums.length === 0) {
                alert("결제할 상품을 선택해주세요.");
                return;
            }

            let form = $("<form></form>");
            form.attr("action", "/pay");
            form.attr("method", "get");

            for (let i = 0; i < roomitem_nums.length; i++) {
                let input = $("<input type='hidden' name='roomitem_nums'></input>");
                input.val(roomitem_nums[i]);
                form.append(input);
            }

            for (let i = 0; i < service_nums.length; i++) {
                let input = $("<input type='hidden' name='service_nums'></input>");
                input.val(service_nums[i]);
                form.append(input);
            }

            $("body").append(form);
            form.submit();
        });

    })

</script>

</body>
</html>