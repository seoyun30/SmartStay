<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/userlayout}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <!-- 스타일 추가 부분 -->
    <style>
        .form-control {
            background-color: #ffffff; /* 배경색을 흰색으로 */
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
        }

        textarea.form-control {
            height: 150px;
            resize: vertical;
        }

        .form-container {
            background-color: #ffffff;  /* 배경색을 흰색으로 설정 */
            border: 1px solid #ccc;    /* 테두리 설정 */
            border-radius: 12px;       /* 둥근 모서리 */
            padding: 20px;             /* 내부 여백 추가 */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* 미세한 그림자 효과 */
        }

        .form-row {
            margin-bottom: 15px;
        }

        .form-label {
            font-weight: bold;
        }

        .button-container {
            text-align: right;
        }

        .btn-dark {
            border-radius: 4px; /* 버튼에도 라운드 처리 */
        }

        .Listbtn{
            margin-right: 10px;
        }
    </style>
</head>

<body>
<th:block layout:fragment="content">

    <div class="d-flex vh-100">
        <div class="container my-auto">
            <div class="row justify-content-center">
                <form action="/qna/qnaRead" method="post" th:object="${qnaDTO}">
                    <div class="row mt-5">
                        <div class="col-8 offset-2">
                            <div class="row">
                                <div class="mb-3 mt-5 text-center">
                                    <h1 class="text-center mb-3 mt-5">상세보기</h1>
                                </div>
                                <div class="col text-center">
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <input type="hidden" id="loggedInUser" th:value="${loggedInEmail}">
                                            <div class="input-group mb-3">
                                                <span class="input-group-text" style="width: 140px">번호</span>
                                                <input type="text"  class="form-control" id="qna_num" th:value="*{qna_num}">
                                            </div>
                                            <div class="input-group mb-3">
                                                <span class="input-group-text" style="width: 140px">제목</span>
                                                <input type="text"  class="form-control" id="title" th:value="${qnaDTO.title}">
                                            </div>
                                            <div class="input-group mb-3">
                                                <span class="input-group-text" style="width: 140px">내용</span>
                                                <textarea  class="form-control" id="content" th:text="${qnaDTO.content}"></textarea>
                                            </div>
                                            <div class="input-group mb-3">
                                                <span class="input-group-text" style="width: 140px">호텔명</span>
                                                <input type="text"  class="form-control" id="hotel" th:value="${qnaDTO.hotelDTO != null ? qnaDTO.hotelDTO.hotel_name : '정보 없음'}">
                                            </div>
                                            <div class="input-group mb-3">
                                                <span class="input-group-text" style="width: 140px">작성자</span>
                                                <input type="text"  class="form-control" id="writer" th:value="${qnaDTO.writer}">
                                            </div>
                                            <div class="input-group mb-3">
                                                <span class="input-group-text" style="width: 140px">조회수</span>
                                                <input type="text"  class="form-control" id="viewCount" th:value="${qnaDTO.viewCount}">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- 버튼 영역 -->
                                <div class="button-container">
                                    <button type="button" class="btn btn-dark Modbtn" style="float:right" th:if="${qnaDTO.writer.equals(loggedInEmail)}">수정</button>
                                    <button type="button" class="btn btn-dark Listbtn" style="float:right">목록</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- 댓글 작성 폼 -->
                <form id="comment-form">
                    <div class="form-group">
                        <label for="comment">답변</label>
                        <textarea class="form-control" id="comment" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" id="qrbtn" style="float:right; margin-left: 10px;">답변 등록</button>
                    <a href="#" class="btn btn-primary float-end modiBtn" data-bs-toggle="modal" data-bs-target="#replyModal" style="display:none">수정</a>
                </form>
                </section>
                <!-- 댓글 섹션 끝 -->
            </div>
        </div>
    </div>
</th:block>

<script th:inline="javascript" layout:fragment="script">
    let qna_num = document.getElementById("qna_num").value;

    /* jQuery */
    $(document).ready(function() {
        $('textarea').on( 'keyup', function (e){
            $(this).css('height', 'auto');
            $(this).height(this.scrollHeight);
        });
        $('textarea').keyup();
    });

    // 목록 버튼 클릭시
    $(".Listbtn").on("click", function () {
        location.href = "/qna/qnaList";
    });

    //수정 버튼 클릭시
    $(".Modbtn").on("click", function () {
        let loggedInUser = $("#loggedInUser").val(); // 로그인한 사용자 정보 (예: 아이디)
        let writer = $("#writer").val(); // 게시글 작성자 정보 (예: 아이디)
        // 작성자가 동일하면 수정 페이지로 이동
        let qna_num = $("#qna_num").val(); // 게시글 번호 가져오기
        location.href = "/qna/qnaModify?qna_num=" + qna_num;
    });

    //댓글
    // 댓글 등록
    const createCommentButton = document.getElementById('qrbtn');

    if (createCommentButton) {
        createCommentButton.addEventListener('click', function(event) {
            event.preventDefault();

            const data = {
                qna_num: qna_num,  // 게시글 번호
                comment: $('#comment').val()
            };

            if (!data.comment || data.comment.trim() === "") {
                alert("공백 또는 입력하지 않은 부분이 있습니다.");
                return false;
            } else {
                body = JSON.stringify({
                    comment: $('#comment').val()
                });

                function success() {
                    alert('등록 완료되었습니다.');
                    location.replace('/qna/qnaRead/' + data.qna_num);  // 댓글 등록 후 해당 QnA 페이지로 이동
                };
                function fail() {
                    alert('등록 실패했습니다.');
                    location.replace('/qna/qnaRead/' + data.qna_num);  // 실패 시에도 해당 QnA 페이지로 이동
                };

                // 요청 URL을 "/qnareply/register"로 수정
                httpRequest('POST', '/qna/qnaRead', body, success, fail);
            }
        });
    }

    // 쿠키를 가져오는 함수
    function getCookie(key) {
        var result = null;
        var cookie = document.cookie.split(';');
        cookie.some(function (item) {
            item = item.replace(' ', '');

            var dic = item.split('=');

            if (key === dic[0]) {
                result = dic[1];
                return true;
            }
        });

        return result;
    }
    function httpRequest(method, url, body, success, fail) {
        alert("success");

        fetch(url, {
            method: method,
            headers: { // 로컬 스토리지에서 액세스 토큰 값을 가져와 헤더에 추가
                Authorization: 'Bearer ' + localStorage.getItem('access_token'),
                'Content-Type': 'application/json',
            },
            body: body,
        }).then(response => {
            if (response.status === 200 || response.status === 201) {
                return success();
            }
            const refresh_token = getCookie('refresh_token');
            if (response.status === 401 && refresh_token) {
                fetch('/api/token', {
                    method: 'POST',
                    headers: {
                        Authorization: 'Bearer ' + localStorage.getItem('access_token'),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        refreshToken: getCookie('refresh_token'),
                    }),
                })
                    .then(res => {
                        if (res.ok) {
                            return res.json();
                        }
                    })
                    .then(result => { // 재발급이 성공하면 로컬 스토리지값을 새로운 액세스 토큰으로 교체
                        localStorage.setItem('access_token', result.accessToken);
                        httpRequest(method, url, body, success, fail);
                    })
                    .catch(error => fail());
            } else {
                return fail();
            }
        });
    }


</script>
</body>
</html>